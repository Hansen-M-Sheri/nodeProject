<!DOCTYPE html>
<html>
<head>
	<title>Notification</title>
		<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="jumbotron bg-info" id="banner">
		<h1>Create and Run Notifications</h1>
		<h4>Originally my plan was to set a notification which would select a topic and frequency that a user would have a scripture texted to them from that topic.  Since the free version of Heroku will not allow for cronjobs which would be required for this, I am simulating th ability for notifications in the following way. This page will show a button for every topic you have entered.  If you click that button, a scripture from that topic will be sent one time to your phone by SMS thru twilio</h4>
	</div>
<div class="container">
		<!-- <form class="form-group col-md-4 col-md-offset-4" method="POST" > -->
			<center><h2>Send a Scripture by Topic to your phone</h2></center><br>
			<div id="buttons">
			</div>
		<!-- </form>	 -->
	</div>

	<script>
		window.addEventListener('load', getTopics);
		
		function getTopics(){
			console.log("Enter Notification: getTopics");
			//check for session
					$.ajax({
			type: "GET",
			url: "/topics",
			success: function(result){
				var topics = JSON.parse(result);
				// console.log("topics: "+topics[0] + " " + topics[1]);
				displayDropDownTopics(topics);
				console.log("Exit Notification: getTopics");
			}

		})
		}

		function getTopicID(name){
			console.log("Enter Notification:getTopicID");
			//check for session
			return new Promise(function(resolve, reject){
				console.log("getTopicID");
				// resolve();
				$.ajax({
					type: "GET",
					url: "/getTopicIDByName?name="+name,
					success: function(result){
						var id = JSON.parse(result);
						// console.log("topics: "+topics[0] + " " + topics[1]);
						console.log("Exit Notification:getTopicID");
						resolve(result);
						} 

					})
			});
			
		}
		function getScriptureCountByTopic(topicID){
			console.log("Enter Notification:getScriptureCountByTopic");
			return new Promise(function(resolve, reject){
				console.log("getScriptureCountByTopic: id="+ result);
				console.log("Exit Notification:getScriptureCountByTopic");
				resolve(1);
			});
		}

		function getRandomInt(count){
			console.log("Enter Notification:getRandomInt");
			return new Promise(function(resolve, reject){
				console.log("getRandomInt with max = "+ count);
				console.log("Exit Notification:getRandomInt");
				resolve(1);
			});
		}

		function getScriptRefByID(id){
			console.log("Enter Notification:getScriptRefByID");
			return new Promise(function(resolve, reject){
				console.log("getScriptRefByID: id = "+ id);
				console.log("Exit Notification:getScriptRefByID");
				resolve("scripture");
			});
		}

		function getUserPhone() {
			console.log("Enter Notification:getUserPhone");
			return new Promise(function(resolve, reject){
				console.log("getUserPhone");
				console.log("Exit Notification:getUserPhone");
				resolve();
			});
		}

		function sendSMS(msg, phone){
			console.log("Enter Notification:sendSMS");
			return new Promise(function(resolve, reject){
				console.log("sendSMS to phone: "+ phone);
				console.log("sms msg: "+msg);
				console.log("Exit Notification:sendSMS");
				resolve();
			});
		}
		function notify(topicName){
			console.log("Enter Notification:notify");
			// 1. get topic id
			// 2. get count of scriptures
			// 3. get random number w/ max cnt of scriptures
			// 4. get reference for that id in topic
			// 5. get user phone
			// 6. call twilio send reference as body
			var phone = '208';
			getTopicID(topicName)
			.then(getScriptureCountByTopic)
			.then(getRandomInt)
			.then(getScriptRefByID)
			// .then(getUserPhone(result)) //authenticate first
			.then(sendSMS(phone));
			console.log("Exit Notification:notify");
			
		}
		//method to send notification by text of random scripture
		// function notify(topicName, getTopicID, getScriptureCountByTopic, getRandomInt, getScriptRefByID ){
		// 	//get topicID
		// 	var id = getTopicID(topicName, );
		// 	//get count of scriptures
		// 	var count = getScriptureCountByTopic(id);
		// 	// this.innerHTML = count;
		// 	// this.className += ' dynamic-success';
		// }

		//display buttons that are options to select for sending text
		function displayDropDownTopics(topics){
			console.log("Enter Notification:displayDropDownTopics");
			var buttons = document.getElementById('buttons');
			
			for(var i = 0; i < topics.length; i++){
				var button = document.createElement('button');
				button.className="btn btn-primary";
				button.id=topics[i].name; 
				button.innerHTML = topics[i].name;
				buttons.appendChild(button);
				// console.log(topics[i].id);
				button.onclick = notify(topics[i].name);
				console.log("Exit Notification:displayDropDownTopics");
			}
		}


		// function getScriptureCountByTopic(topicID){
		// 	$.ajax({
		// 	type: "GET",
		// 	url: "/getNumScripturesByTopicID?id="+topicID,
		// 	success: function(result){
		// 		var count = JSON.parse(result);
		// 		return(count);
		// 	}

		// })
		// }
		// function getRandomInt(min, max) {
		//   min = Math.ceil(min);
		//   max = Math.floor(max);
		//   return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
		// }
	</script>
</body>
</html>